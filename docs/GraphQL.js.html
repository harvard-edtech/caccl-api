<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>GraphQL.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav style="border-right: 2px solid #ccc; padding-bottom: 25px;" >
    
    <h2><a style="font-size: 30px;" href="index.html">CACCL API</a></h2><h3>Endpoint Functions</h3><ul><li><a href="api.account.html">api.account</a><ul class='methods'><li data-type='method'><a href="api.account.html#get">get</a></li><li data-type='method'><a href="api.account.html#list">list</a></li><li data-type='method'><a href="api.account.html#listAdmins">listAdmins</a></li><li data-type='method'><a href="api.account.html#listCourses">listCourses</a></li></ul></li><li><a href="api.account.enrollmentTerm.html">api.account.enrollmentTerm</a><ul class='methods'><li data-type='method'><a href="api.account.enrollmentTerm.html#get">get</a></li><li data-type='method'><a href="api.account.enrollmentTerm.html#list">list</a></li></ul></li><li><a href="api.course.html">api.course</a><ul class='methods'><li data-type='method'><a href="api.course.html#get">get</a></li><li data-type='method'><a href="api.course.html#getUser">getUser</a></li><li data-type='method'><a href="api.course.html#listDesignerEnrollments">listDesignerEnrollments</a></li><li data-type='method'><a href="api.course.html#listDesigners">listDesigners</a></li><li data-type='method'><a href="api.course.html#listEnrollments">listEnrollments</a></li><li data-type='method'><a href="api.course.html#listObserverEnrollments">listObserverEnrollments</a></li><li data-type='method'><a href="api.course.html#listObservers">listObservers</a></li><li data-type='method'><a href="api.course.html#listStudentEnrollments">listStudentEnrollments</a></li><li data-type='method'><a href="api.course.html#listStudents">listStudents</a></li><li data-type='method'><a href="api.course.html#listTAs">listTAs</a></li><li data-type='method'><a href="api.course.html#listTeachers">listTeachers</a></li><li data-type='method'><a href="api.course.html#listTeachingTeamMemberEnrollments">listTeachingTeamMemberEnrollments</a></li><li data-type='method'><a href="api.course.html#listTeachingTeamMembers">listTeachingTeamMembers</a></li><li data-type='method'><a href="api.course.html#listUsers">listUsers</a></li></ul></li><li><a href="api.course.analytics.html">api.course.analytics</a><ul class='methods'><li data-type='method'><a href="api.course.analytics.html#getStudentMessagingData">getStudentMessagingData</a></li><li data-type='method'><a href="api.course.analytics.html#getStudentParticipationData">getStudentParticipationData</a></li><li data-type='method'><a href="api.course.analytics.html#getStudentSummary">getStudentSummary</a></li><li data-type='method'><a href="api.course.analytics.html#listAssignmentSummaries">listAssignmentSummaries</a></li><li data-type='method'><a href="api.course.analytics.html#listDailyActivitySummaries">listDailyActivitySummaries</a></li><li data-type='method'><a href="api.course.analytics.html#listStudentSummaries">listStudentSummaries</a></li></ul></li><li><a href="api.course.announcement.html">api.course.announcement</a><ul class='methods'><li data-type='method'><a href="api.course.announcement.html#list">list</a></li></ul></li><li><a href="api.course.app.html">api.course.app</a><ul class='methods'><li data-type='method'><a href="api.course.app.html#add">add</a></li><li data-type='method'><a href="api.course.app.html#get">get</a></li><li data-type='method'><a href="api.course.app.html#getAssignmentLaunchURL">getAssignmentLaunchURL</a></li><li data-type='method'><a href="api.course.app.html#getMetadata">getMetadata</a></li><li data-type='method'><a href="api.course.app.html#getNavLaunchURL">getNavLaunchURL</a></li><li data-type='method'><a href="api.course.app.html#list">list</a></li><li data-type='method'><a href="api.course.app.html#remove">remove</a></li><li data-type='method'><a href="api.course.app.html#updateMetadata">updateMetadata</a></li></ul></li><li><a href="api.course.assignment.html">api.course.assignment</a><ul class='methods'><li data-type='method'><a href="api.course.assignment.html#create">create</a></li><li data-type='method'><a href="api.course.assignment.html#createFileSubmission">createFileSubmission</a></li><li data-type='method'><a href="api.course.assignment.html#createOverride">createOverride</a></li><li data-type='method'><a href="api.course.assignment.html#createSubmissionComment">createSubmissionComment</a></li><li data-type='method'><a href="api.course.assignment.html#createTextSubmission">createTextSubmission</a></li><li data-type='method'><a href="api.course.assignment.html#createURLSubmission">createURLSubmission</a></li><li data-type='method'><a href="api.course.assignment.html#delete">delete</a></li><li data-type='method'><a href="api.course.assignment.html#deleteOverride">deleteOverride</a></li><li data-type='method'><a href="api.course.assignment.html#get">get</a></li><li data-type='method'><a href="api.course.assignment.html#getOverride">getOverride</a></li><li data-type='method'><a href="api.course.assignment.html#getSubmission">getSubmission</a></li><li data-type='method'><a href="api.course.assignment.html#list">list</a></li><li data-type='method'><a href="api.course.assignment.html#listAllSubmissions">listAllSubmissions</a></li><li data-type='method'><a href="api.course.assignment.html#listGradeableStudents">listGradeableStudents</a></li><li data-type='method'><a href="api.course.assignment.html#listOverrides">listOverrides</a></li><li data-type='method'><a href="api.course.assignment.html#listSubmissions">listSubmissions</a></li><li data-type='method'><a href="api.course.assignment.html#update">update</a></li><li data-type='method'><a href="api.course.assignment.html#updateGrade">updateGrade</a></li><li data-type='method'><a href="api.course.assignment.html#updateGrades">updateGrades</a></li><li data-type='method'><a href="api.course.assignment.html#updateOverride">updateOverride</a></li></ul></li><li><a href="api.course.assignmentGroup.html">api.course.assignmentGroup</a><ul class='methods'><li data-type='method'><a href="api.course.assignmentGroup.html#create">create</a></li><li data-type='method'><a href="api.course.assignmentGroup.html#delete">delete</a></li><li data-type='method'><a href="api.course.assignmentGroup.html#get">get</a></li><li data-type='method'><a href="api.course.assignmentGroup.html#list">list</a></li><li data-type='method'><a href="api.course.assignmentGroup.html#update">update</a></li></ul></li><li><a href="api.course.discussionTopic.html">api.course.discussionTopic</a><ul class='methods'><li data-type='method'><a href="api.course.discussionTopic.html#create">create</a></li><li data-type='method'><a href="api.course.discussionTopic.html#delete">delete</a></li><li data-type='method'><a href="api.course.discussionTopic.html#list">list</a></li><li data-type='method'><a href="api.course.discussionTopic.html#listEntries">listEntries</a></li></ul></li><li><a href="api.course.gradebookColumn.html">api.course.gradebookColumn</a><ul class='methods'><li data-type='method'><a href="api.course.gradebookColumn.html#create">create</a></li><li data-type='method'><a href="api.course.gradebookColumn.html#delete">delete</a></li><li data-type='method'><a href="api.course.gradebookColumn.html#get">get</a></li><li data-type='method'><a href="api.course.gradebookColumn.html#list">list</a></li><li data-type='method'><a href="api.course.gradebookColumn.html#listEntries">listEntries</a></li><li data-type='method'><a href="api.course.gradebookColumn.html#update">update</a></li><li data-type='method'><a href="api.course.gradebookColumn.html#updateEntries">updateEntries</a></li><li data-type='method'><a href="api.course.gradebookColumn.html#updateEntry">updateEntry</a></li></ul></li><li><a href="api.course.group.html">api.course.group</a><ul class='methods'><li data-type='method'><a href="api.course.group.html#get">get</a></li><li data-type='method'><a href="api.course.group.html#listMembers">listMembers</a></li><li data-type='method'><a href="api.course.group.html#updateMembers">updateMembers</a></li></ul></li><li><a href="api.course.groupSet.html">api.course.groupSet</a><ul class='methods'><li data-type='method'><a href="api.course.groupSet.html#create">create</a></li><li data-type='method'><a href="api.course.groupSet.html#createGroup">createGroup</a></li><li data-type='method'><a href="api.course.groupSet.html#delete">delete</a></li><li data-type='method'><a href="api.course.groupSet.html#deleteGroup">deleteGroup</a></li><li data-type='method'><a href="api.course.groupSet.html#get">get</a></li><li data-type='method'><a href="api.course.groupSet.html#getGroup">getGroup</a></li><li data-type='method'><a href="api.course.groupSet.html#list">list</a></li><li data-type='method'><a href="api.course.groupSet.html#listGroups">listGroups</a></li></ul></li><li><a href="api.course.page.html">api.course.page</a><ul class='methods'><li data-type='method'><a href="api.course.page.html#create">create</a></li><li data-type='method'><a href="api.course.page.html#delete">delete</a></li><li data-type='method'><a href="api.course.page.html#get">get</a></li><li data-type='method'><a href="api.course.page.html#list">list</a></li><li data-type='method'><a href="api.course.page.html#update">update</a></li></ul></li><li><a href="api.course.quiz.html">api.course.quiz</a><ul class='methods'><li data-type='method'><a href="api.course.quiz.html#create">create</a></li><li data-type='method'><a href="api.course.quiz.html#createEssayQuestion">createEssayQuestion</a></li><li data-type='method'><a href="api.course.quiz.html#createMultipleChoiceQuestion">createMultipleChoiceQuestion</a></li><li data-type='method'><a href="api.course.quiz.html#createShortAnswerQuestion">createShortAnswerQuestion</a></li><li data-type='method'><a href="api.course.quiz.html#createSubmission">createSubmission</a></li><li data-type='method'><a href="api.course.quiz.html#delete">delete</a></li><li data-type='method'><a href="api.course.quiz.html#get">get</a></li><li data-type='method'><a href="api.course.quiz.html#getSubmission">getSubmission</a></li><li data-type='method'><a href="api.course.quiz.html#list">list</a></li><li data-type='method'><a href="api.course.quiz.html#listQuestionGrades">listQuestionGrades</a></li><li data-type='method'><a href="api.course.quiz.html#listQuestions">listQuestions</a></li><li data-type='method'><a href="api.course.quiz.html#listSubmissions">listSubmissions</a></li><li data-type='method'><a href="api.course.quiz.html#update">update</a></li><li data-type='method'><a href="api.course.quiz.html#updateQuestionGrades">updateQuestionGrades</a></li></ul></li><li><a href="api.course.rubric.html">api.course.rubric</a><ul class='methods'><li data-type='method'><a href="api.course.rubric.html#createFreeFormGradingRubricInAssignment">createFreeFormGradingRubricInAssignment</a></li><li data-type='method'><a href="api.course.rubric.html#get">get</a></li><li data-type='method'><a href="api.course.rubric.html#list">list</a></li></ul></li><li><a href="api.course.section.html">api.course.section</a><ul class='methods'><li data-type='method'><a href="api.course.section.html#get">get</a></li><li data-type='method'><a href="api.course.section.html#list">list</a></li></ul></li><li><a href="api.graphQL.html">api.graphQL</a><ul class='methods'><li data-type='method'><a href="api.graphQL.html#sendQuery">sendQuery</a></li></ul></li><li><a href="api.other.html">api.other</a><ul class='methods'><li data-type='method'><a href="api.other.html#endpoint">endpoint</a></li></ul></li><li><a href="api.user.html">api.user</a></li><li><a href="api.user.self.html">api.user.self</a><ul class='methods'><li data-type='method'><a href="api.user.self.html#getProfile">getProfile</a></li><li data-type='method'><a href="api.user.self.html#listCourses">listCourses</a></li></ul></li></ul>
</nav>

<div id="main">
    
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Functions for sending graphQL requests
 * @namespace api.graphQL
 */

const EndpointCategory = require('../../classes/EndpointCategory');

class GraphQL extends EndpointCategory {
  constructor(config) {
    super(config, GraphQL);
  }
}

/*------------------------------------------------------------------------*/
/*                              Helper Class                              */
/*------------------------------------------------------------------------*/

class QLItem {
  /**
   * Create a new QL Item
   * @ignore
   * @author Gabe Abrams
   * @param {string|string[]} query - the query text or lines to parse
   * @param {boolean} [parentHasCursor] - if true, a parent has a cursor so
   *   any cursors found here or in children will be ignored
   */
  constructor(query, parentHasCursor = false) {
    // Get list of lines
    const lines = (
      Array.isArray(query)
        ? query
        : query.trim().split('\n')
    );

    // Create a cursor
    this.cursor = null;

    // Separate lines into firstLine, innerLines, lastLine
    const firstLine = lines[0];
    const innerLines = [];
    for (let i = 1; i &lt; lines.length - 1; i++) {
      innerLines.push(lines[i].trim());
    }

    // Name
    this.name = (
      firstLine
        .trim()
        .match(/^[^({]+/)[0]
        .trim()
    );

    // Connection
    this.isPagedConnection = (
      !parentHasCursor
      &amp;&amp; this.name.endsWith('Connection')
    );

    // Params
    this.params = null;
    if (firstLine.includes('(')) {
      this.params = {};
    }
    if (firstLine.match(/\((.*:.*)\)/)) {
      const paramString = firstLine.match(/\((.*:.*)\)/)[0];

      // Process the string
      paramString
        // Remove parentheses
        .substring(1, paramString.length - 1)
        // Split into params
        .split(',')
        // Trim whitespace
        .map((param) => {
          return param.trim();
        })
        // Filter the "after" param
        .filter((param) => {
          return !param.startsWith('after:');
        })
        // Parse
        .forEach((param) => {
          try {
            const [left, right] = param.split(':');

            this.params[left.trim()] = JSON.parse(right.trim());
          } catch (err) {
            throw new Error(`Param "${param}" could not be processed in "${firstLine}"`);
          }
        });
    }

    // Recurse for children
    this.children = [];
    let additionalIndentation = 0;
    let thisChildsLines = [];
    innerLines.forEach((line) => {
      // Add the current line to the child's array
      thisChildsLines.push(line);

      // Check for open/close
      if (line.endsWith('{')) {
        // Open! Increment indentation
        additionalIndentation += 1;
      } else if (line === '}') {
        // Close! Decrement indentation
        additionalIndentation -= 1;
      }

      // Check for finished child
      if (additionalIndentation === 0) {
        // Child finished!

        // Create child
        this.children.push(
          new QLItem(
            thisChildsLines,
            this.isPagedConnection || parentHasCursor
          )
        );

        // Reset
        thisChildsLines = [];
      }
    });

    // If paged connection, flatten "node"
    if (this.isPagedConnection) {
      this.children = (
        // Go through our children
        this.children
          // Get the node child and extract its children
          .filter((child) => {
            return (child.getName() === 'nodes');
          })[0].children
      );
    }
  }

  /**
   * Get info on the cursor
   * @ignore
   * @author Gabe Abrams
   * @return {function} data merger that takes two arguments: current data and
   *   data returned from the new request and returns the merged data object
   */
  getDataMerger(propArray = []) {
    // Check if we found the cursor
    if (this.isPagedConnection) {
      return (data, newData) => {
        // If no data yet, just use the new data
        if (!data) {
          return newData;
        }

        // Data exists. Add new entries to the old data
        // > Find the location in both data objects
        let dataObj = data;
        let newDataObj = newData;
        propArray.forEach((prop) => {
          dataObj = dataObj[prop];
          newDataObj = newDataObj[prop];
        });
        // > Copy items over
        newDataObj.nodes.forEach((item) => {
          dataObj.nodes.push(item);
        });
        // > Remove useless page info
        delete dataObj.pageInfo;

        return data;
      };
    }

    // Haven't found cursor yet. Try with all children
    for (let i = 0; i &lt; this.children.length; i++) {
      // Update prop array
      const newPropArray = [...propArray];
      newPropArray.push(this.children[i].getName());

      // Recurse
      const dataMerger = this.children[i].getDataMerger(newPropArray);

      if (dataMerger) {
        return dataMerger;
      }
    }
  }

  /**
   * Get the name of this item
   * @ignore
   * @author Gabe Abrams
   * @return {string} name
   */
  getName() {
    return this.name;
  }

  /**
   * Get the next query text
   * @ignore
   * @author Gabe Abrams
   * @param {boolean} [isSubItem] - true if this item is a sub item
   * @return {string} text for the next query
   */
  getNextQuery(isSubItem) {
    const lines = [];

    // Prefix based on indentation
    const prefix = (
      isSubItem
        ? '  '
        : ''
    );

    // Add first line
    // > Hardcoded params
    let paramPart = '';
    if (this.params !== null) {
      const innerText = (
        Object.keys(this.params)
          .map((key) => {
            const value = this.params[key];
            return `${key}: ${JSON.stringify(value)}`;
          })
          .join(', ')
      );
      paramPart = `(${innerText})`;
    }
    // > Cursor param
    if (this.cursor) {
      // Add spacer
      if (paramPart.length > 2) { // More than the parens
        paramPart = paramPart.replace(')', ', )');
      }

      // Add "after"
      paramPart = paramPart.replace(')', `after: "${this.cursor}")`);
    }
    // > Open parens
    const opener = (
      this.children.length > 0
        ? ' {'
        : ''
    );
    lines.push(`${prefix}${this.name}${paramPart}${opener}`);

    // Add before-children part if is connection
    let additionalChildPrefix = '';
    if (this.isPagedConnection) {
      // Add "nodes {" part
      lines.push(`${prefix}  nodes {`);
      additionalChildPrefix = '  ';
    }

    // Add lines from children
    this.children.forEach((child) => {
      const childLines = child.getNextQuery(true);

      childLines.forEach((line) => {
        lines.push(`${prefix}${additionalChildPrefix}${line}`);
      });
    });

    // Add after-children part if is connection
    if (this.isPagedConnection) {
      // Add node closer
      lines.push(`${prefix}  }`);

      // Add pageInfo request
      lines.push(`${prefix}  pageInfo {`);
      lines.push(`${prefix}    endCursor`);
      lines.push(`${prefix}    hasNextPage`);
      lines.push(`${prefix}  }`);
    }

    // Add last line
    if (this.children.length > 0) {
      // Closer
      lines.push(`${prefix}}`);
    }

    // Return
    return (
      isSubItem
        ? lines
        : lines.join('\n')
    );
  }

  /**
   * Ingest the response
   * @ignore
   * @author Gabe Abrams
   * @param {object} data - the contents of the data object
   * @return {object} status in the form { cursorUpdated, hasNextPage }
   *   true if another page needs to be fetched
   */
  ingestResponse(data) {
    // Get the container of the data for the children
    const childDataContainer = (
      this.isPagedConnection
        ? data.nodes
        : data
    );

    // Check if we found a cursor
    if (
      this.isPagedConnection
      &amp;&amp; data.pageInfo
      &amp;&amp; data.pageInfo.endCursor
    ) {
      // Found a cursor that needs to be updated
      this.cursor = data.pageInfo.endCursor;

      // Current item needs another page
      return {
        cursorUpdated: true,
        hasNextPage: !!data.pageInfo.hasNextPage,
      };
    }

    // This item doesn't have a cursor. Check children
    for (let i = 0; i &lt; this.children.length; i++) {
      const child = this.children[i];

      // Get the data for the child
      const childData = childDataContainer[child.getName()];
      const status = child.ingestResponse(childData);

      if (status.cursorUpdated) {
        return status;
      }
    }

    return { cursorUpdated: false };
  }
}

/*------------------------------------------------------------------------*/
/*                               Endpoints:                               */
/*------------------------------------------------------------------------*/

/**
 * Send a GraphQL request to Canvas and fetch all pages. Note: for paged
 *   responses, only the first top-level paged connection is supported (nested
 *   pagination is not supported).
 * @author Gabe Abrams
 * @method sendQuery
 * @memberof api.graphQL
 * @instance
 * @async
 * @param {object} options - object containing all arguments
 * @param {string} options.query - the GraphQL query string
 * @param {function} [options.onNewPage] - handler to call when there
 *   is a new page (called with all data up until now)
 * @return {object} GraphQL response
 */
GraphQL.sendQuery = function (options) {
  // Create a helper object
  const qlItem = new QLItem(options.query);
  const mergeData = (
    qlItem.getDataMerger()
    // Use replacer function if no merger
    || (
      (_, y) => {
        return y;
      }
    )
  );

  // Keep track of all data
  let allData;

  // Helper function for fetching another page
  const fetchPage = () => {
    // Get the next query
    const query = qlItem.getNextQuery();

    // Send the request
    return this.visitEndpoint({
      path: '/api/graphql',
      method: 'POST',
      params: { query },
    })
      .then((response) => {
        // Get data from the response
        const { data } = response;

        // Merge data
        allData = mergeData(allData, data);

        // Call handler
        if (options.onNewPage) {
          options.onNewPage(allData);
        }

        // Check if we need to send another request
        const { hasNextPage } = qlItem.ingestResponse(data);

        // Either finish or send another request
        if (hasNextPage) {
          // More data
          return fetchPage();
        }
        // All done!
        return allData;
      });
  };

  // Kick off the domino effect of getting pages
  return fetchPage();
};
GraphQL.sendQuery.action = 'get a batch of data from Canvas';
GraphQL.sendQuery.requiredParams = ['query'];
GraphQL.sendQuery.scopes = [];

/*------------------------------------------------------------------------*/
/*                                 Export                                 */
/*------------------------------------------------------------------------*/

module.exports = GraphQL;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
We use <a href="https://github.com/jsdoc3/jsdoc">JSDoc</a> and the <a href="https://github.com/clenemt/docdash">docdash</a> theme to generate our docs.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
